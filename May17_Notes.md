# Register Allocation - Graph Coloring and Linear Scan

## 1. 什么是我们的问题？

在这一节中，我们会讨论寄存器的分配问题。那么，问题是什么呢？

1. 在中间表示（Intermediate Representation, IR) 中， 例如LLVM,  为了将寄存器与代码分开，并使两者都更简单，我们假设有无限数量的寄存器。

2.  但是在现实的设计中，我们只有有限数量的寄存器。所以我们需要用有限数量的真寄存器（Real Register) 去替换虚拟寄存器（Virtual Register)。但是，一个真实的寄存器在每个点只能替换一个虚拟寄存器。有时候，当我们没有足够的真寄存器，我们必须进行spill溢出处理。



## 2. 我们该如何优化

1. 通常情况下，我们会生成代码，优化无限数量的寄存器，然后再分配有限数量的寄存器（通常是4-32个）

2. 我们需要考虑两个部分，Allocation分配和Assignment分派

   注意到：在编译器中，分配与分派是两个不同的概念。

   - **分配（Allocation）**：确定这些变量中，哪些变量需要使用寄存器。如果寄存器数量有限，可能会有些变量需要被分配到内存中。
   - **分派（Assignment）**：一旦确定了需要使用寄存器的变量，接下来就要具体分派给它们具体的寄存器。比如，变量A用寄存器R1，变量B用寄存器R2，等等。

   

## 3. 变量的生存空间Liveness Range 重叠带来的干扰问题

<img src="./May17_Notes.assets/%E6%88%AA%E5%B1%8F2024-05-22%20%E4%B8%8A%E5%8D%8810.34.13.png" alt="截屏2024-05-22 上午10.34.13" style="zoom: 33%;" />

1. 在本页ppt中，两个变量t0和t1的liveness range有重叠，因此他们在同一时间都需要寄存器，无法共享寄存器。
2. 生存空间(liveness): 指一个变量从定义到最后一次使用的代码区间。
3. 干扰(interference): 如果两个变量的生存区间重叠，他们就会产生干扰，这两个变量不能共享同一个物理寄存器。



## 4. Inteference Graph and K-Coloring Problem 干扰图与K-着色问题

1. Interference Graph: 每个节点Node代表一个虚拟寄存器，如果两个节点之间有一条边，说明两个虚拟寄存器在同一时间都需要寄存器。

2. K-Coloring Problem: 在干扰图中，用K种颜色给图中的节点上色，相邻的节点颜色不能一样。

   （如果干扰图可以用k种颜色着色，那么我们就能用K个物理寄存器分配这些虚拟寄存器，同时不会有冲突）

3. 例子1: 用3种颜色color the graph

   <img src="./May17_Notes.assets/%E6%88%AA%E5%B1%8F2024-05-22%20%E4%B8%8A%E5%8D%8811.03.55.png" style="zoom: 25%;" />

4. 例子2: 同样的图，如果我们只能用两种颜色呢？

   因为这张图不能用两种颜色（2-color）进行着色。我们需要选择一个节点（虚拟寄存器）进行溢出（spill）。

   如何溢出：

   - 选择一个高度连接的节点进行溢出。在图中，t1 是高度连接的节点（与 t0 和 t2 都有边）。
   - 将 t1 溢出到内存中，而不是保存在物理寄存器中。
   - 溢出意味着这个虚拟寄存器的数据将被保存在内存中，当需要使用它时，再从内存中加载。

   - **节点 t1 被着色为红色**，表示它是被选择进行溢出的节点。
   - 通过将 t1 溢出，我们减少了物理寄存器的需求，使得剩余的虚拟寄存器可以被分配到物理寄存器中。

<img src="./May17_Notes.assets/%E6%88%AA%E5%B1%8F2024-05-22%20%E4%B8%8A%E5%8D%8811.06.39.png" style="zoom: 25%;" />

## 5. Graph Coloring Allocators 优缺点的讨论

1. 优点：

   （1） 经典，常用的寄存器分配方法

   （2） 每种合法的k-coloring都是一个合法的寄存器分配方案

2. 缺点：

   （1）并不是所有合法的寄存器分配方案都是K-coloring的。启发式算法可能无法找到所有k-coloring的方案

   （2）对即时编译器（JITs)代价太高。Graph Coloring在计算复杂度和时间消耗上较高

   （3）不适合SSA(Static Singe Assignment)静态单赋值形式

              1. Phi函数：在SSA形式中，phi函数用于表示变量的多个赋值来源，图着色方法难以处理这些phi函数。
              1. 生存区间（Live Range）：SSA形式中的变量生存区间定义与传统形式不同，使得图着色方法难以直接应用。
